"""
å®¢æˆ·åé¦ˆæ™ºèƒ½åˆ†æç³»ç»Ÿ

è¿™ä¸ªç³»ç»Ÿæ¼”ç¤ºäº†ä¸€ä¸ªæœ‰å®é™…å•†ä¸šä»·å€¼çš„å¤šæ­¥éª¤åˆ†æé“¾æ¡ï¼š

å®¢æˆ·åé¦ˆæ–‡æœ¬
    |
    v
+---------------------------+
| 1. é—®é¢˜åˆ†ç±»ä¸æå–         |
| (äº§å“/æœåŠ¡/ä»·æ ¼/ä½“éªŒç­‰)   |
+---------------------------+
    |
    v
+---------------------------+
| 2. æƒ…æ„Ÿå¼ºåº¦åˆ†æ           |
| (1-10åˆ† + å…³é”®è¯)        |
+---------------------------+
    |
    v
+---------------------------+
| 3. ç´§æ€¥ç¨‹åº¦è¯„ä¼°           |
| (é«˜/ä¸­/ä½ + ç†ç”±)        |
+---------------------------+
    |
    v
+---------------------------+
| 4. è¡ŒåŠ¨å»ºè®®ç”Ÿæˆ           |
| (å…·ä½“çš„ä¸šåŠ¡æ”¹è¿›æ–¹æ¡ˆ)      |
+---------------------------+
    |
    v
ç»“æ„åŒ–çš„åˆ†ææŠ¥å‘Š + å¯æ‰§è¡Œçš„è¡ŒåŠ¨è®¡åˆ’
"""

from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
from langchain_openai import ChatOpenAI
from langchain_core.runnables import RunnableLambda, RunnablePassthrough
from dotenv import load_dotenv
import json
import re

load_dotenv()
model = ChatOpenAI(temperature=0.3)  # é™ä½æ¸©åº¦ä»¥è·å¾—æ›´ä¸€è‡´çš„ç»“æœ

class CustomerFeedbackAnalyzer:
    """å®¢æˆ·åé¦ˆæ™ºèƒ½åˆ†æå™¨"""
    
    def __init__(self):
        self.model = model
        self.analysis_results = {}
    
    def create_analysis_chain(self):
        """åˆ›å»ºå®Œæ•´çš„å®¢æˆ·åé¦ˆåˆ†æé“¾"""
        
        # æ­¥éª¤1ï¼šé—®é¢˜åˆ†ç±»ä¸æå–
        category_prompt = ChatPromptTemplate.from_template(
            """
            è¯·åˆ†æä»¥ä¸‹å®¢æˆ·åé¦ˆï¼Œè¯†åˆ«å¹¶åˆ†ç±»å…¶ä¸­æåˆ°çš„é—®é¢˜ï¼š
            
            åé¦ˆå†…å®¹ï¼š{feedback}
            
            è¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š
            é—®é¢˜ç±»åˆ«ï¼š[äº§å“è´¨é‡/å®¢æˆ·æœåŠ¡/ä»·æ ¼/ç‰©æµé…é€/ç”¨æˆ·ä½“éªŒ/åŠŸèƒ½éœ€æ±‚/å…¶ä»–]
            æ ¸å¿ƒé—®é¢˜ï¼š[ç”¨ä¸€å¥è¯æ¦‚æ‹¬ä¸»è¦é—®é¢˜]
            æ¶‰åŠé¢†åŸŸï¼š[å…·ä½“çš„äº§å“çº¿æˆ–æœåŠ¡ç¯èŠ‚]
            """
        )
        
        # æ­¥éª¤2ï¼šæƒ…æ„Ÿå¼ºåº¦åˆ†æ
        sentiment_prompt = ChatPromptTemplate.from_template(
            """
            åŸºäºå®¢æˆ·åé¦ˆå’Œé—®é¢˜åˆ†ç±»ç»“æœï¼Œè¿›è¡Œæƒ…æ„Ÿå¼ºåº¦åˆ†æï¼š
            
            åŸå§‹åé¦ˆï¼š{original_feedback}
            é—®é¢˜åˆ†ç±»ï¼š{category_result}
            
            è¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š
            æƒ…æ„Ÿå€¾å‘ï¼š[ç§¯æ/ä¸­æ€§/æ¶ˆæ]
            å¼ºåº¦è¯„åˆ†ï¼š[1-10åˆ†ï¼Œ10åˆ†ä¸ºæœ€å¼ºçƒˆ]
            æƒ…æ„Ÿå…³é”®è¯ï¼š[æå–2-3ä¸ªæœ€èƒ½ä½“ç°æƒ…æ„Ÿçš„è¯è¯­]
            å®¢æˆ·æ»¡æ„åº¦ï¼š[å¾ˆæ»¡æ„/æ»¡æ„/ä¸€èˆ¬/ä¸æ»¡æ„/å¾ˆä¸æ»¡æ„]
            """
        )
        
        # æ­¥éª¤3ï¼šç´§æ€¥ç¨‹åº¦è¯„ä¼°
        urgency_prompt = ChatPromptTemplate.from_template(
            """
            åŸºäºé—®é¢˜åˆ†ç±»å’Œæƒ…æ„Ÿåˆ†æç»“æœï¼Œè¯„ä¼°æ­¤åé¦ˆçš„ç´§æ€¥å¤„ç†ç¨‹åº¦ï¼š
            
            é—®é¢˜åˆ†ç±»ï¼š{category_result}
            æƒ…æ„Ÿåˆ†æï¼š{sentiment_result}
            
            è€ƒè™‘å› ç´ ï¼š
            - é—®é¢˜ä¸¥é‡æ€§ï¼ˆå½±å“ä½¿ç”¨/å®‰å…¨/è´¢åŠ¡ï¼‰
            - å®¢æˆ·æƒ…æ„Ÿå¼ºåº¦
            - æ½œåœ¨çš„ä¼ æ’­é£é™©
            - è§£å†³éš¾åº¦å’Œæ—¶æ•ˆæ€§
            
            è¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š
            ç´§æ€¥ç­‰çº§ï¼š[é«˜/ä¸­/ä½]
            å“åº”æ—¶é™ï¼š[2å°æ—¶å†…/24å°æ—¶å†…/3å¤©å†…/1å‘¨å†…]
            é£é™©è¯„ä¼°ï¼š[é«˜é£é™©/ä¸­é£é™©/ä½é£é™©]
            ç†ç”±è¯´æ˜ï¼š[ç®€è¦è¯´æ˜ç´§æ€¥ç¨‹åº¦åˆ¤æ–­ä¾æ®]
            """
        )
        
        # æ­¥éª¤4ï¼šè¡ŒåŠ¨å»ºè®®ç”Ÿæˆ
        action_prompt = ChatPromptTemplate.from_template(
            """
            åŸºäºå®Œæ•´åˆ†æç»“æœï¼Œç”Ÿæˆå…·ä½“çš„è¡ŒåŠ¨å»ºè®®ï¼š
            
            é—®é¢˜åˆ†ç±»ï¼š{category_result}
            æƒ…æ„Ÿåˆ†æï¼š{sentiment_result}
            ç´§æ€¥ç¨‹åº¦ï¼š{urgency_result}
            
            è¯·ç”Ÿæˆè¯¦ç»†çš„è¡ŒåŠ¨è®¡åˆ’ï¼š
            
            ç«‹å³è¡ŒåŠ¨ï¼š
            - [éœ€è¦ç«‹å³æ‰§è¡Œçš„å…·ä½“æªæ–½]
            
            çŸ­æœŸæªæ–½ï¼ˆ1å‘¨å†…ï¼‰ï¼š
            - [çŸ­æœŸå†…éœ€è¦å®Œæˆçš„æ”¹è¿›æªæ–½]
            
            é•¿æœŸä¼˜åŒ–ï¼ˆ1ä¸ªæœˆå†…ï¼‰ï¼š
            - [é•¿æœŸçš„ç³»ç»Ÿæ€§æ”¹è¿›å»ºè®®]
            
            è´£ä»»éƒ¨é—¨ï¼š[å»ºè®®ç”±å“ªä¸ªéƒ¨é—¨è´Ÿè´£å¤„ç†]
            é¢„æœŸæ•ˆæœï¼š[é¢„æœŸèƒ½è¾¾åˆ°çš„æ”¹å–„æ•ˆæœ]
            è·Ÿè¿›æ–¹å¼ï¼š[å»ºè®®çš„å®¢æˆ·è·Ÿè¿›æ–¹æ³•]
            """
        )
        
        # æ„å»ºå®Œæ•´çš„åˆ†æé“¾
        analysis_chain = (
            # æ­¥éª¤1ï¼šé—®é¢˜åˆ†ç±»
            RunnablePassthrough.assign(
                category_result=category_prompt | self.model | StrOutputParser()
            )
            # æ­¥éª¤2ï¼šæƒ…æ„Ÿåˆ†æ
            | RunnablePassthrough.assign(
                sentiment_result=RunnableLambda(lambda x: (
                    sentiment_prompt | self.model | StrOutputParser()
                ).invoke({
                    "original_feedback": x["feedback"],
                    "category_result": x["category_result"]
                }))
            )
            # æ­¥éª¤3ï¼šç´§æ€¥ç¨‹åº¦è¯„ä¼°
            | RunnablePassthrough.assign(
                urgency_result=RunnableLambda(lambda x: (
                    urgency_prompt | self.model | StrOutputParser()
                ).invoke({
                    "category_result": x["category_result"],
                    "sentiment_result": x["sentiment_result"]
                }))
            )
            # æ­¥éª¤4ï¼šè¡ŒåŠ¨å»ºè®®
            | RunnableLambda(lambda x: {
                **x,
                "action_plan": (action_prompt | self.model | StrOutputParser()).invoke({
                    "category_result": x["category_result"],
                    "sentiment_result": x["sentiment_result"],
                    "urgency_result": x["urgency_result"]
                })
            })
        )
        
        return analysis_chain
    
    def analyze_feedback(self, feedback_text, debug=True):
        """
        åˆ†æå®¢æˆ·åé¦ˆ
        
        Args:
            feedback_text (str): å®¢æˆ·åé¦ˆæ–‡æœ¬
            debug (bool): æ˜¯å¦æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
            
        Returns:
            dict: å®Œæ•´çš„åˆ†æç»“æœ
        """
        chain = self.create_analysis_chain()
        result = chain.invoke({"feedback": feedback_text})
        
        if debug:
            self.print_analysis_results(feedback_text, result)
        
        return result
    
    def print_analysis_results(self, original_feedback, results):
        """æ ¼å¼åŒ–æ‰“å°åˆ†æç»“æœ"""
        print("=" * 80)
        print("ğŸ“ å®¢æˆ·åé¦ˆæ™ºèƒ½åˆ†ææŠ¥å‘Š")
        print("=" * 80)
        
        print(f"\nğŸ“‹ åŸå§‹åé¦ˆ:\n{original_feedback}")
        
        print(f"\nğŸ·ï¸  æ­¥éª¤1 - é—®é¢˜åˆ†ç±»ä¸æå–:")
        print(f"{results['category_result']}")
        
        print(f"\nğŸ˜Š æ­¥éª¤2 - æƒ…æ„Ÿå¼ºåº¦åˆ†æ:")
        print(f"{results['sentiment_result']}")
        
        print(f"\nğŸš¨ æ­¥éª¤3 - ç´§æ€¥ç¨‹åº¦è¯„ä¼°:")
        print(f"{results['urgency_result']}")
        
        print(f"\nğŸ’¡ æ­¥éª¤4 - è¡ŒåŠ¨å»ºè®®:")
        print(f"{results['action_plan']}")
        
        print("=" * 80)

def main():
    """ä¸»å‡½æ•°ï¼Œæµ‹è¯•ä¸åŒç±»å‹çš„å®¢æˆ·åé¦ˆ"""
    
    analyzer = CustomerFeedbackAnalyzer()
    
    # æµ‹è¯•æ¡ˆä¾‹1ï¼šäº§å“è´¨é‡é—®é¢˜ï¼ˆé«˜ç´§æ€¥åº¦ï¼‰
    feedback_1 = """
    æˆ‘æ˜¨å¤©æ”¶åˆ°çš„æ™ºèƒ½æ‰‹è¡¨å‡ºç°äº†ä¸¥é‡é—®é¢˜ï¼å¼€æœºåå±å¹•ä¸€ç›´é—ªçƒï¼Œæ ¹æœ¬æ— æ³•æ­£å¸¸ä½¿ç”¨ã€‚
    æˆ‘æ˜¯èŠ±äº†2000å¤šå—é’±ä¹°çš„ï¼Œç»“æœè¿åŸºæœ¬åŠŸèƒ½éƒ½ç”¨ä¸äº†ã€‚å®¢æœç”µè¯ä¹Ÿä¸€ç›´å çº¿ï¼Œ
    å®Œå…¨è”ç³»ä¸ä¸Šäººã€‚è¿™ç§è´¨é‡çœŸçš„è®©äººå¾ˆå¤±æœ›ï¼Œæˆ‘è¦æ±‚ç«‹å³é€€è´§å¹¶ç»™å‡ºåˆç†è§£é‡Šï¼
    å¦‚æœä¸èƒ½å¦¥å–„å¤„ç†ï¼Œæˆ‘ä¼šåœ¨å„å¤§å¹³å°æŠ•è¯‰ã€‚
    """
    
    print("ğŸ” åˆ†ææ¡ˆä¾‹1ï¼šäº§å“è´¨é‡é—®é¢˜")
    analyzer.analyze_feedback(feedback_1)
    
    # # æµ‹è¯•æ¡ˆä¾‹2ï¼šæœåŠ¡ä½“éªŒé—®é¢˜ï¼ˆä¸­ç­‰ç´§æ€¥åº¦ï¼‰
    # feedback_2 = """
    # æ•´ä½“æ¥è¯´äº§å“è¿˜ä¸é”™ï¼Œä½†æ˜¯æœ‰å‡ ä¸ªåœ°æ–¹å¸Œæœ›èƒ½æ”¹è¿›ä¸€ä¸‹ã€‚é¦–å…ˆæ˜¯ç‰©æµé€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œ
    # è®¢å•æ˜¾ç¤º3-5å¤©åˆ°è´§ï¼Œå®é™…ç”¨äº†8å¤©æ‰æ”¶åˆ°ã€‚å…¶æ¬¡æ˜¯åŒ…è£…å¯ä»¥å†ç²¾ç¾ä¸€äº›ï¼Œ
    # ä½œä¸ºç¤¼å“é€äººçš„è¯ç°åœ¨çš„åŒ…è£…æ˜¾å¾—æœ‰ç‚¹ç®€é™‹ã€‚å®¢æœæ€åº¦è¿˜ç®—å¯ä»¥ï¼Œ
    # ä½†æ˜¯ä¸“ä¸šåº¦æœ‰å¾…æé«˜ï¼Œæœ‰äº›æŠ€æœ¯é—®é¢˜å›ç­”å¾—ä¸å¤Ÿå‡†ç¡®ã€‚å¸Œæœ›ä½ ä»¬èƒ½ç»§ç»­ä¼˜åŒ–ã€‚
    # """
    
    # print("\nğŸ” åˆ†ææ¡ˆä¾‹2ï¼šæœåŠ¡ä½“éªŒé—®é¢˜")
    # analyzer.analyze_feedback(feedback_2)
    
    # # æµ‹è¯•æ¡ˆä¾‹3ï¼šåŠŸèƒ½éœ€æ±‚å»ºè®®ï¼ˆä½ç´§æ€¥åº¦ï¼‰
    # feedback_3 = """
    # ç”¨äº†ä¸€ä¸ªæœˆçš„appï¼Œæ•´ä½“ä½“éªŒå¾ˆå¥½ï¼Œç•Œé¢è®¾è®¡å¾ˆæ¸…çˆ½ï¼ŒåŠŸèƒ½ä¹Ÿæ¯”è¾ƒé½å…¨ã€‚
    # æœ‰ä¸ªå°å»ºè®®ï¼šèƒ½ä¸èƒ½å¢åŠ å¤œé—´æ¨¡å¼ï¼Ÿæ™šä¸Šä½¿ç”¨çš„æ—¶å€™è§‰å¾—æœ‰ç‚¹åˆºçœ¼ã€‚
    # å¦å¤–ï¼Œå¦‚æœèƒ½å¢åŠ æ•°æ®å¯¼å‡ºåŠŸèƒ½å°±æ›´å®Œç¾äº†ï¼Œè¿™æ ·æˆ‘å°±èƒ½æŠŠæ•°æ®å¤‡ä»½åˆ°å…¶ä»–åœ°æ–¹ã€‚
    # æ€»çš„æ¥è¯´å¾ˆæ»¡æ„ï¼Œä¼šæ¨èç»™æœ‹å‹ä½¿ç”¨çš„ã€‚æœŸå¾…åç»­ç‰ˆæœ¬çš„æ›´æ–°ï¼
    # """
    
    # print("\nğŸ” åˆ†ææ¡ˆä¾‹3ï¼šåŠŸèƒ½éœ€æ±‚å»ºè®®")
    # analyzer.analyze_feedback(feedback_3)

if __name__ == "__main__":
    main()